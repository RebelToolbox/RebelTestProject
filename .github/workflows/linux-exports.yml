name: 🐧 Linux Exports
on:
  push:
  pull_request:
  schedule:
    # Run a test every week: on Sunday night at midnight.
    - cron: '0 0 * * 1'

jobs:
  linux-exports:
    name: ${{ matrix.name }}
    runs-on: "ubuntu-20.04"
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux Debug Export
            artifact: linux-debug-export
            engine-build-options: use_asan=yes use_ubsan=yes use_llvm=yes use_lld=yes
            rebel-engine: RebelEngine/bin/godot.x11.tools.64.llvms
            template-build-options: tools=no target=release debug_symbols=yes use_asan=yes use_ubsan=yes use_llvm=yes use_lld=yes
            template: RebelEngine/bin/godot.x11.opt.64.llvms
            export-preset: Linux/X11
            export-preset-key: LINUX_DEBUG_TEMPLATE
            project: linux-debug-project

    steps:
      - name: Checkout Rebel Test Project
        uses: actions/checkout@v3

      - name: Checkout Rebel Engine
        uses: actions/checkout@v3
        with:
          repository: RebelToolbox/RebelEngine
          path: RebelEngine

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          build-essential \
          pkg-config \
          clang \
          python3 \
          scons \
          libx11-dev \
          libxcursor-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxi-dev \
          libgl-dev \
          libudev-dev \
          libasound2-dev \
          libpulse-dev \
          yasm

      - name: Compile Rebel Engine
        working-directory: RebelEngine
        run: scons -j2 ${{ matrix.engine-build-options }}

      - name: Compile Export Template
        working-directory: RebelEngine
        run: scons -j2 ${{ matrix.template-build-options }}

      - name: Export Project
        run: |
          template="$(pwd)/${{ matrix.template }}"
          sed -i "s|${{ matrix.export-preset-key }}|$template|" export_presets.cfg
          DRI_PRIME=0 xvfb-run ${{ matrix.rebel-engine }} --export-debug "${{ matrix.export-preset }}" ${{ matrix.project }} 2>&1 | tee export.log
          ./check_log.py export.log

      - name: Run Linux Export Project
        run: |
          DRI_PRIME=0 xvfb-run ./${{ matrix.project }} 300 2>&1 | tee project.log
          ./check_log.py project.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.project }}
            export.log
            project.log
          retention-days: 14
