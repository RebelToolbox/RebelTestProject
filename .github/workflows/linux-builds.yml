name: 🐧 Linux Builds
on:
  push:
  pull_request:
  schedule:
    # Run a test every week: on Sunday night at midnight.
    - cron: '0 0 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  linux-builds:
    name: ${{ matrix.name }}
    runs-on: "ubuntu-20.04"
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Clang release
            artifact: clang-release
            build-options: target=release_debug use_llvm=yes use_lld=yes
            rebel-engine: RebelEngine/bin/godot.x11.opt.tools.64.llvm

          - name: Clang address (includes leak) and undefined bahaviour sanitizers
            artifact: clang-asan-ubsan-sanitizers
            build-options: use_asan=yes use_ubsan=yes use_llvm=yes use_lld=yes
            rebel-engine: RebelEngine/bin/godot.x11.tools.64.llvms

          - name: Clang thread sanitizer
            artifact: clang-tsan-sanitizer
            build-options: use_tsan=yes use_llvm=yes use_lld=yes
            rebel-engine: RebelEngine/bin/godot.x11.tools.64.llvms

          - name: GCC address (includes leak) and undefined behavour sanitizers
            artifact: gcc-asan-ubsan-sanitizers
            build-options: use_asan=yes use_ubsan=yes
            rebel-engine: RebelEngine/bin/godot.x11.tools.64s

    steps:
      - name: Checkout Rebel Test Project
        uses: actions/checkout@v3

      - name: Checkout Rebel Engine
        uses: actions/checkout@v3
        with:
          repository: RebelToolbox/RebelEngine
          path: RebelEngine

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          build-essential \
          pkg-config \
          clang \
          lld \
          python3 \
          scons \
          libx11-dev \
          libxcursor-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxi-dev \
          libgl-dev \
          libudev-dev \
          libasound2-dev \
          libpulse-dev \
          yasm

      - name: Compile Rebel Engine
        working-directory: RebelEngine
        run: scons -j2 ${{ matrix.build-options }}

      # Open Editor to import assets
      - name: Open Rebel Engine Editor
        run: |
          DRI_PRIME=0 xvfb-run ${{ matrix.rebel-engine }} -e -q 2>&1 | tee editor.log
          ./check_log.py editor.log

      - name: Run Rebel Engine Test Project
        run: |
          DRI_PRIME=0 xvfb-run ${{ matrix.rebel-engine }} 300 2>&1 | tee project.log
          ./check_log.py project.log

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.artifact }}-logs
          path: |
            editor.log
            project.log
          retention-days: 14
